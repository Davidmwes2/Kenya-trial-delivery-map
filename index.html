<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        
        <title>Logistics Delivery Map</title>

        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
        <link rel="stylesheet" href="css/L.Control.Locate.min.css">
        <link rel="stylesheet" href="css/qgis2web.css">
        <link rel="stylesheet" href="css/fontawesome-all.min.css">
        <link rel="stylesheet" href="css/leaflet-measure.css">
        
        <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />

        <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }
        /* Style for the Clear Route button */
        .clear-route-btn {
            background-color: white;
            width: 34px;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 4px;
            border: 2px solid rgba(0,0,0,0.2);
        }
        .clear-route-btn:hover { background-color: #f4f4f4; }
        </style>
    </head>
    <body>
        <div id="map"></div>

        <script src="js/qgis2web_expressions.js"></script>
        <script src="js/leaflet.js"></script>
        <script src="js/L.Control.Layers.Tree.min.js"></script>
        <script src="js/L.Control.Locate.min.js"></script>
        <script src="js/leaflet-svg-shape-markers.min.js"></script>
        <script src="js/leaflet.rotatedMarker.js"></script>
        <script src="js/leaflet.pattern.js"></script>
        <script src="js/leaflet-hash.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        <script src="js/leaflet-measure.js"></script>
        
        <script src="data/Selectedcountiesken_admin1_1.js"></script>
        <script src="data/Polygonsmerged__merged_2.js"></script>
        <script src="data/Nurseriesnurseries_3.js"></script>
        <script src="data/Singlepartplotsingle_parts_4.js"></script>

        <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

        <script>
        var map = L.map('map', {
            zoomControl:false, maxZoom:28, minZoom:1
        });
        
        var hash = new L.Hash(map);
        var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});

        // --- 1. LOGISTICS SETUP (TRUCK & ROUTING) ---
        var truckLat = 0;
        var truckLng = 0;
        var truckMarker = null;

        var truckIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/1048/1048313.png',
            iconSize: [40, 40],
            iconAnchor: [20, 20]
        });

        var routingControl = L.Routing.control({
            waypoints: [],
            routeWhileDragging: true,
            show: true,
            lineOptions: { styles: [{color: '#2A81CB', opacity: 0.8, weight: 6}] }
        }).addTo(map);

        // --- 2. GPS TRACKING LOGIC ---
        map.on('locationfound', function(e) {
            truckLat = e.latitude;
            truckLng = e.longitude;
            if (truckMarker === null) {
                truckMarker = L.marker([truckLat, truckLng], {icon: truckIcon}).addTo(map);
                truckMarker.bindPopup("<b>Truck Location</b>");
            } else {
                truckMarker.setLatLng([truckLat, truckLng]);
            }
        });
        map.locate({setView: true, watch: true, maxZoom: 16});

        // --- 3. CLEAR ROUTE BUTTON ---
        var ClearRouteControl = L.Control.extend({
            options: { position: 'topright' },
            onAdd: function (map) {
                var container = L.DomUtil.create('div', 'clear-route-btn');
                container.innerHTML = '<i class="fas fa-trash-alt" title="Clear Route"></i>';
                container.onclick = function() { routingControl.setWaypoints([]); };
                return container;
            }
        });
        map.addControl(new ClearRouteControl());

        // --- 4. BASE LAYERS ---
        map.createPane('pane_OSMStandard_0');
        map.getPane('pane_OSMStandard_0').style.zIndex = 400;
        var layer_OSMStandard_0 = L.tileLayer('http://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            pane: 'pane_OSMStandard_0',
            opacity: 1.0,
            attribution: 'Â© OpenStreetMap contributors',
            minZoom: 1, maxZoom: 28
        }).addTo(map);

        // --- 5. DATA LAYERS (Counties & Nurseries) ---
        function pop_Nurseriesnurseries_3(feature, layer) {
            var content = '<b>Nursery:</b> ' + feature.properties['Nursery'];
            layer.bindPopup(content);
            layer.on('click', function(e) {
                if(truckLat !== 0) routingControl.setWaypoints([L.latLng(truckLat, truckLng), e.latlng]);
            });
        }

        var layer_Nurseriesnurseries_3 = new L.geoJson(json_Nurseriesnurseries_3, {
            onEachFeature: pop_Nurseriesnurseries_3,
            pointToLayer: function (feature, latlng) {
                return L.shapeMarker(latlng, { radius: 9, fillColor: '#729b6f', fillOpacity: 1, color: '#234c23', weight: 1 });
            }
        }).addTo(map);

        // --- 6. FARMER LAYER (CLICK TO ROUTE) ---
        function pop_Singlepartplotsingle_parts_4(feature, layer) {
            var content = '<b>Farmer:</b> ' + feature.properties['Name'] + '<br><b>Area:</b> ' + feature.properties['Area'];
            layer.bindPopup(content);
            layer.on('click', function (e) {
                if (truckLat !== 0) {
                    routingControl.setWaypoints([L.latLng(truckLat, truckLng), e.latlng]);
                } else {
                    alert("Still waiting for your GPS location...");
                }
            });
        }

        var layer_Singlepartplotsingle_parts_4 = new L.geoJson(json_Singlepartplotsingle_parts_4, {
            onEachFeature: pop_Singlepartplotsingle_parts_4,
            pointToLayer: function (feature, latlng) {
                var color = feature.properties['Area'] > 1.0 ? '#eb5300' : '#ffff00';
                return L.circleMarker(latlng, { radius: 6, fillColor: color, fillOpacity: 1, color: '#000', weight: 1 });
            },
        }).addTo(map);

        // --- 7. UI CONTROLS ---
        L.control.zoom({ position: 'topleft' }).addTo(map);
        new L.Control.Measure({ position: 'topleft' }).addTo(map);

        // Initial view
        var bounds_group = new L.featureGroup([layer_Nurseriesnurseries_3, layer_Singlepartplotsingle_parts_4]);
        map.fitBounds(bounds_group.getBounds());
        </script>
    </body>
</html>