<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <title>Logistics Delivery Map</title>

        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="css/qgis2web.css">
        <link rel="stylesheet" href="css/fontawesome-all.min.css">
        
        <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
        <link rel="stylesheet" href="https://unpkg.com/leaflet-search@2.9.8/dist/leaflet-search.min.css" />

        <style>
            html, body, #map { width: 100%; height: 100%; padding: 0; margin: 0; }
            .clear-route-btn {
                background: white; width: 34px; height: 34px; 
                display: flex; align-items: center; justify-content: center;
                cursor: pointer; border-radius: 4px; border: 2px solid rgba(0,0,0,0.2);
            }
        /* Make the search bar wider and taller for mobile */
.leaflet-control-search.search-exp {
    width: 250px !important; /* Increase width */
    height: 40px !important; /* Increase height */
}

.leaflet-control-search .search-input {
    width: 200px !important;
    height: 34px !important;
    font-size: 16px !important; /* Prevents iPhone from auto-zooming when typing */
    margin: 3px !important;
}

/* Make the magnifying glass icon larger */
.leaflet-control-search .search-button {
    width: 40px !important;
    height: 40px !important;
    background-size: 24px 24px !important;
}</style>
    </head>
    <body>
        <div id="map"></div>

        <script src="js/leaflet.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/leaflet-svg-shape-markers.min.js"></script>
        
        <script src="data/Selectedcountiesken_admin1_1.js"></script>
        <script src="data/Nurseriesnurseries_3.js"></script>
        <script src="data/Singlepartplotsingle_parts_4.js"></script>

        <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
        <script src="https://unpkg.com/leaflet-search@2.9.8/dist/leaflet-search.min.js"></script>

        <script>
        var map = L.map('map', { zoomControl:false, maxZoom:28, minZoom:1 });

        // --- 1. DEFINE BASE MAPS ---
        var streetView = L.tileLayer('http://tile.openstreetmap.org/{z}/{x}/{y}.png', { opacity: 1.0 }).addTo(map);
        var satelliteView = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', { opacity: 1.0 });

        // --- 2. TRUCK & ROUTING SETUP ---
        var truckLat = 0, truckLng = 0, truckMarker = null;
        var truckIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/1048/1048313.png',
            iconSize: [40, 40], iconAnchor: [20, 20]
        });

        var routingControl = L.Routing.control({
            waypoints: [],
            routeWhileDragging: true,
            lineOptions: { styles: [{color: '#2A81CB', opacity: 0.8, weight: 6}] }
        }).addTo(map);

        // --- 3. GPS TRACKING ---
        map.on('locationfound', function(e) {
            truckLat = e.latitude; truckLng = e.longitude;
            if (!truckMarker) {
                truckMarker = L.marker([truckLat, truckLng], {icon: truckIcon}).addTo(map);
            } else {
                truckMarker.setLatLng([truckLat, truckLng]);
            }
        });
        map.locate({setView: true, watch: true, maxZoom: 16});

        // --- 4. DATA LAYERS ---
        // Nurseries
        var layer_Nurseries = new L.geoJson(json_Nurseriesnurseries_3, {
            onEachFeature: function(feature, layer) {
                layer.bindPopup('Nursery: ' + feature.properties['Nursery']);
                layer.on('click', function(e) {
                    if(truckLat !== 0) routingControl.setWaypoints([L.latLng(truckLat, truckLng), e.latlng]);
                });
            },
            pointToLayer: function (feature, latlng) {
                return L.shapeMarker(latlng, { radius: 9, fillColor: '#729b6f', fillOpacity: 1, color: '#234c23', weight: 1 });
            }
        }).addTo(map);

        // Farmers
        var layer_Farmers = new L.geoJson(json_Singlepartplotsingle_parts_4, {
            onEachFeature: function(feature, layer) {
                layer.bindPopup('Farmer: ' + feature.properties['Name']);
                layer.on('click', function(e) {
                    if(truckLat !== 0) routingControl.setWaypoints([L.latLng(truckLat, truckLng), e.latlng]);
                });
            },
            pointToLayer: function (feature, latlng) {
                var color = feature.properties['Area'] > 1.0 ? '#eb5300' : '#ffff00';
                return L.circleMarker(latlng, { radius: 6, fillColor: color, fillOpacity: 1, color: '#000', weight: 1 });
            }
        }).addTo(map);

        // --- 5. UI CONTROLS (Layer Toggle & Search) ---
        
        // Toggle Box (Top Right)
        var baseMaps = { "Street View": streetView, "Satellite View": satelliteView };
        L.control.layers(baseMaps, null, {collapsed: false}).addTo(map);

        // Search Bar (Top Left)
        var searchControl = new L.Control.Search({
            layer: layer_Farmers,
            propertyName: 'Name', // Ensure 'Name' matches your QGIS column!
            marker: false,
            moveToLocation: function(latlng, title, map) { map.setView(latlng, 17); }
        });
        map.addControl(searchControl);

        // Clear Route Button
        var ClearBtn = L.Control.extend({
            options: { position: 'topright' },
            onAdd: function (map) {
                var div = L.DomUtil.create('div', 'clear-route-btn');
                div.innerHTML = 'üóëÔ∏è';
                div.onclick = function() { routingControl.setWaypoints([]); };
                return div;
            }
        });
        map.addControl(new ClearBtn());

        L.control.zoom({ position: 'topleft' }).addTo(map);
        </script>
    </body>
</html>